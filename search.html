<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>검색 결과 - AUTOLAB</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Noto Sans KR -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap" rel="stylesheet">

    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <!-- Favicon -->
    <link rel="icon" href="./favicon2.png" type="image/png">

    <style>
        /* Custom Styles */
        body {
            font-family: 'Noto Sans KR', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        @media (min-width: 1024px) {
            .dropdown:hover .dropdown-menu {
                display: block;
                animation: fadeInDown 0.3s ease-out;
            }
        }
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .rotate-180 {
            transform: rotate(180deg);
        }
        .line-clamp-2 {
            overflow: hidden;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 2;
        }
    </style>
</head>
<body class="bg-white text-gray-700">

    <!-- Header -->
    <header id="header" class="bg-white/80 backdrop-blur-md sticky top-0 left-0 right-0 z-50 border-b border-gray-200/80 transition-all duration-300">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-20">
                <!-- Logo -->
                <a href="./index.html" class="flex items-center space-x-2 shrink-0">
                    <img src="./logo.png" alt="AUTOLAB Logo" class="h-8 md:h-10">
                </a>

                <!-- Desktop Navigation -->
                <div class="flex items-center">
                    <nav id="desktop-nav" class="hidden lg:flex items-center space-x-2">
                         <div class="dropdown relative">
                            <a href="./index.html" class="px-4 py-2 text-lg font-medium text-gray-600 hover:text-sky-600 rounded-md">회사소개</a>
                            <div class="dropdown-menu absolute hidden bg-white shadow-lg rounded-md mt-2 py-2 w-40 border border-gray-100">
                                <a href="./index.html" class="block px-4 py-2 text-gray-700 hover:bg-sky-50 hover:text-sky-600">AUTOLAB 소개</a>
                                <a href="./index.html" class="block px-4 py-2 text-gray-700 hover:bg-sky-50 hover:text-sky-600">사업연혁</a>
                                <a href="./index.html" class="block px-4 py-2 text-gray-700 hover:bg-sky-50 hover:text-sky-600">오시는길</a>
                            </div>
                        </div>
                        <div class="dropdown relative">
                            <a href="./index.html" class="px-4 py-2 text-lg font-medium text-gray-600 hover:text-sky-600 rounded-md">사업분야</a>
                            <div class="dropdown-menu absolute hidden bg-white shadow-lg rounded-md mt-2 py-2 w-48 border border-gray-100">
                                <a href="./index.html" class="block px-4 py-2 text-gray-700 hover:bg-sky-50 hover:text-sky-600">센서 개발 R&D</a>
                                <a href="./index.html" class="block px-4 py-2 text-gray-700 hover:bg-sky-50 hover:text-sky-600">ICT 교육</a>
                            </div>
                        </div>
                        <a href="./index.html" class="px-4 py-2 text-lg font-medium text-gray-600 hover:text-sky-600">제품소개</a>
                        <a href="./index.html" class="px-4 py-2 text-lg font-medium text-gray-600 hover:text-sky-600">견적문의</a>
                        <div class="dropdown relative">
                            <a href="./index.html" class="px-4 py-2 text-lg font-medium text-gray-600 hover:text-sky-600 rounded-md">커뮤니티</a>
                            <div class="dropdown-menu absolute hidden bg-white shadow-lg rounded-md mt-2 py-2 w-40 border border-gray-100">
                                <a href="./index.html" class="block px-4 py-2 text-gray-700 hover:bg-sky-50 hover:text-sky-600">About us</a>
                                <a href="./index.html" class="block px-4 py-2 text-gray-700 hover:bg-sky-50 hover:text-sky-600">포토갤러리</a>
                            </div>
                        </div>
                    </nav>
                    <button class="search-btn hidden lg:block ml-4 p-3 text-gray-500 hover:text-sky-600"><i class="fas fa-search"></i></button>
                </div>

                <!-- Mobile Menu Button -->
                <div class="lg:hidden">
                    <button id="mobile-menu-button" class="text-gray-700 hover:text-sky-500 focus:outline-none p-2"><i class="fas fa-bars fa-lg"></i></button>
                </div>
            </div>
        </div>
        <!-- Mobile Navigation -->
        <div id="mobile-menu" class="hidden lg:hidden bg-white border-t border-gray-200"></div>
    </header>

    <!-- Main Content -->
    <main>
        <section class="py-20 lg:py-32">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div id="search-info" class="text-center mb-12">
                    <h1 class="text-3xl md:text-4xl font-extrabold text-gray-800">검색 결과</h1>
                    <p id="search-query-display" class="mt-4 text-lg text-gray-600"></p>
                </div>

                <!-- Results sections -->
                <div id="results-container" class="space-y-16">
                    <!-- Products Results -->
                    <section id="products-results-section" class="hidden">
                        <h2 class="text-2xl font-bold border-b-2 border-sky-500 pb-2 mb-6">제품소개</h2>
                        <div id="products-grid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-8"></div>
                    </section>

                    <!-- About Us Results -->
                    <section id="about-us-results-section" class="hidden">
                        <h2 class="text-2xl font-bold border-b-2 border-sky-500 pb-2 mb-6">About us</h2>
                        <div id="about-us-list" class="border-t border-gray-200"></div>
                    </section>

                    <!-- Gallery Results -->
                    <section id="gallery-results-section" class="hidden">
                        <h2 class="text-2xl font-bold border-b-2 border-sky-500 pb-2 mb-6">포토갤러리</h2>
                        <div id="gallery-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-x-4 gap-y-8"></div>
                    </section>

                    <!-- No Results Message -->
                    <div id="no-results" class="hidden text-center py-20">
                        <p class="text-xl text-gray-500">검색 결과가 없습니다.</p>
                    </div>
                </div>
            </div>
        </section>
    </main>
    
    <!-- Search Modal -->
    <div id="search-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-[60] flex items-start justify-center p-4 pt-24">
        <div class="relative bg-white rounded-lg shadow-xl w-full max-w-4xl">
            <div class="flex items-center p-2 border-b">
                <i class="fas fa-search text-gray-400 mx-3"></i>
                <input type="text" id="search-input" placeholder="검색어를 입력하세요..." class="w-full p-3 border-0 focus:ring-0">
                <button id="close-search-btn" class="p-3 text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <!-- 🆕 검색 결과 영역 추가 -->
            <div id="search-results" class="hidden border-t border-gray-200">
                <div id="search-results-content" class="p-4 max-h-96 overflow-y-auto"></div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyAN0bbCZg8K2V12a-zpbf23_Z4U8CYmBms",
            authDomain: "autolab-1cd53.firebaseapp.com",
            projectId: "autolab-1cd53",
            storageBucket: "autolab-1cd53.appspot.com",
            messagingSenderId: "734510998647",
            appId: "1:734510998647:web:f5547055d5ab933d279272",
            measurementId: "G-CD93HMRDM5"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const searchQueryDisplay = document.getElementById('search-query-display');
        const noResults = document.getElementById('no-results');

        async function fetchAndSearch() {
            const urlParams = new URLSearchParams(window.location.search);
            const searchTerm = urlParams.get('q');
            const resultsContainer = document.getElementById('results-container');
        
            if (!searchTerm) {
                searchQueryDisplay.textContent = "검색어를 입력해주세요.";
                noResults.classList.remove('hidden');
                return;
            }
        
            searchQueryDisplay.innerHTML = `'<span class="text-sky-600">${searchTerm}</span>'에 대한 검색 결과입니다.`;
            const lowerCaseSearchTerm = searchTerm.toLowerCase();
            let totalResults = 0;
        
            // 💡 1. 모든 데이터를 가져옵니다. (site_content 추가)
            const siteContentPromise = getDocs(collection(db, 'site_content'));
            const aboutUsPromise = getDocs(query(collection(db, 'about_us'), orderBy("createdAt", "desc")));
            const galleryPromise = getDocs(query(collection(db, 'gallery'), orderBy("createdAt", "desc")));
        
            const [siteContentSnapshot, aboutUsSnapshot, gallerySnapshot] = await Promise.all([
                siteContentPromise,
                aboutUsPromise,
                galleryPromise,
            ]);
        
            // site_content 데이터를 검색하기 쉬운 형태로 가공
            const siteContent = {};
            siteContentSnapshot.forEach(doc => {
                siteContent[doc.id] = doc.data().value;
            });
        
            const allData = { ...siteContent };
        
            const foundItems = {};
        
            // 💡 2. 통합 검색: site_content를 포함한 모든 데이터를 검색합니다.
            for (const key in allData) {
                const value = allData[key];
                if (typeof value === 'string' && value.toLowerCase().includes(lowerCaseSearchTerm)) {
                    // 예: 'product-ict-1.title' -> 'product-ict-1'
                    const pageKey = key.split('.')[0]; 
        
                    if (!foundItems[pageKey]) {
                        foundItems[pageKey] = {
                            title: allData[`${pageKey}.title`] || '제목 없음',
                            subtitle: allData[`${pageKey}.subtitle`] || allData[`${pageKey}.description`] || '',
                            image: allData[`${pageKey}.image`] || 'https://placehold.co/600x400/e0f2fe/1e3a8a?text=Image',
                            type: '페이지'
                        };
                    }
                }
            }
        
            // About Us 검색
            aboutUsSnapshot.docs.forEach(doc => {
                const item = doc.data();
                if (item.title.toLowerCase().includes(lowerCaseSearchTerm) || item.content.toLowerCase().includes(lowerCaseSearchTerm)) {
                    foundItems[`about-us-item-${doc.id}`] = {
                        title: item.title,
                        subtitle: item.content,
                        date: item.createdAt ? item.createdAt.toDate().toLocaleDateString('ko-KR') : '',
                        type: 'About us'
                    };
                }
            });
        
            // 갤러리 검색
            gallerySnapshot.docs.forEach(doc => {
                const item = doc.data();
                if (item.title.toLowerCase().includes(lowerCaseSearchTerm) || (item.description && item.description.toLowerCase().includes(lowerCaseSearchTerm))) {
                     foundItems[`gallery-item-${doc.id}`] = {
                        title: item.title,
                        subtitle: item.description,
                        image: item.imageUrl,
                        type: '포토갤러리'
                    };
                }
            });
        
            // 💡 3. 검색 결과를 화면에 동적으로 생성합니다.
            resultsContainer.innerHTML = ''; // 기존 결과 초기화
            totalResults = Object.keys(foundItems).length;
        
            if (totalResults > 0) {
                for (const key in foundItems) {
                    const item = foundItems[key];
                    const link = `index.html#${key.split('-item-')[0]}`; // 올바른 페이지로 링크
                    const itemEl = document.createElement('a');
                    itemEl.href = link;
                    itemEl.className = 'block p-6 border rounded-lg hover:bg-gray-50 hover:shadow-md transition-all';
                    itemEl.innerHTML = `
                        <div class="flex flex-col sm:flex-row gap-6">
                            ${item.image ? `<img src="${item.image}" class="w-full sm:w-40 h-32 object-cover rounded-md flex-shrink-0">` : ''}
                            <div class="flex-grow">
                                <div class="flex justify-between items-start">
                                    <span class="text-sm font-semibold text-sky-600">${item.type}</span>
                                    ${item.date ? `<span class="text-sm text-gray-500">${item.date}</span>` : ''}
                                </div>
                                <h3 class="text-xl font-bold text-gray-800 mt-1">${item.title}</h3>
                                <p class="text-gray-600 mt-2 line-clamp-2">${item.subtitle}</p>
                            </div>
                        </div>
                    `;
                    resultsContainer.appendChild(itemEl);
                }
            } else {
                resultsContainer.innerHTML = '<div id="no-results" class="text-center py-20"><p class="text-xl text-gray-500">검색 결과가 없습니다.</p></div>';
            }
        }

        fetchAndSearch();
        
        // --- Search Modal Logic ---
        const searchModal = document.getElementById('search-modal');
        const searchInput = document.getElementById('search-input');
        const closeSearchBtn = document.getElementById('close-search-btn');

        function openSearch() {
            searchModal.classList.remove('hidden');
            searchInput.focus();
        }
        function closeSearch() {
            searchModal.classList.add('hidden');
        }

        document.querySelectorAll('.search-btn').forEach(btn => btn.addEventListener('click', openSearch));
        closeSearchBtn.addEventListener('click', closeSearch);
        searchModal.addEventListener('click', (e) => {
            if (e.target === searchModal) closeSearch();
        });

        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const searchTerm = e.target.value.trim();
                if (searchTerm) {
                    window.location.href = `./search.html?q=${encodeURIComponent(searchTerm)}`;
                }
            }
        });
        
        // --- Mobile Menu Logic ---
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileMenuContainer = document.getElementById('mobile-menu');
        const desktopNav = document.getElementById('desktop-nav');

        function buildMobileMenu() {
            mobileMenuContainer.innerHTML = ''; 
            const navItems = desktopNav.children;
            for (const item of navItems) {
                const clonedItem = item.cloneNode(true);
                // Convert all links to simple hrefs for the separate search page
                clonedItem.querySelectorAll('a').forEach(link => {
                    link.href = './index.html'; 
                });
                mobileMenuContainer.appendChild(clonedItem);
            }
        }
        buildMobileMenu();
        mobileMenuButton.addEventListener('click', () => {
            mobileMenuContainer.classList.toggle('hidden');
        });

    </script>
</body>
</html>
